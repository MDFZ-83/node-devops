pipeline{
    agent any

    environment{
        DOCKER_IMAGE= "mohammadfeizi/node-devops"
    }

    stages{
        stage("checkout"){
            steps{
                git "https://github.com/MDFZ-83/node-devops.git"
            }
        }

        stage("build & test"){
            steps{
                bat "npm install"
                
            }
        }

        stage("docker build & push"){
            steps{
                echo "Starting Docker build..."
                bat "docker build -t $DOCKER_IMAGE ."
                echo "Docker build complete."

                withCredentials([usernamePassword(credentialsId: "DockerHub-credential", usernameVariable: "DOCKER_USER", passwordVariable: "DOCKER_PASSWORD")]) {
                    echo "Logging into Docker Hub..."
                    bat "echo %DOCKER_PASSWORD%% | docker login -u %%DOCKER_USER% --password-stdin"
                    echo "Login successful."
                    
                    echo "Pushing Docker image..."
                    bat "docker push %DOCKER_IMAGE%"
                    echo "Docker push complete."

                }
            }
        }


        stage("Terraform Init & Apply"){
            steps{
                bat "cd terraform"
                bat "terraform init"
                bat "terraform apply -auto-approve"
            }
        }

        stage("Deploy Kubernetes"){
            steps{
                bat "kubectl apply -f k8s/"
            }
        }
    }
}
